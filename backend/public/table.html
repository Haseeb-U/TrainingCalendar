<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Training Sessions Table</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #0d1117;
      color: white;
    }
    nav {
      background-color: #1e1e1e;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      position: relative;
    }
    .nav-title {
      font-size: 20px;
      font-weight: bold;
      color: #03c988;
    }
    .nav-links {
      position: relative;
    }
    .nav-links a, .dropdown-btn {
      margin-left: 20px;
      text-decoration: none;
      color: #d1d5db;
      font-weight: 500;
      cursor: pointer;
    }
    .nav-links a:hover, .dropdown-btn:hover {
      color: #03c988;
    }
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #1e1e1e;
      min-width: 120px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1;
      right: 0;
    }
    .dropdown-content a {
      color: #d1d5db;
      padding: 10px 16px;
      text-decoration: none;
      display: block;
    }
    .dropdown-content a:hover {
      background-color: #2a2e35;
      color: #03c988;
    }
    .dropdown:hover .dropdown-content {
      display: block;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 40px 20px;
    }
    h1 {
      font-size: 36px;
      margin-bottom: 20px;
    }
    .summary {
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: bold;
      color: #34d399;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #161b22;
      border-radius: 12px;
      overflow: hidden;
    }
    thead tr {
      background-color: #34d399;
      color: white;
    }
    th, td {
      padding: 12px 16px;
      border-bottom: 1px solid #2a2e35;
      text-align: left;
      font-weight: 600;
    }
    tbody tr:hover {
      background-color: #23303f;
    }
    .edit-cell, .delete-cell, .checkbox-cell {
      text-align: center;
    }
    button.btn-edit, button.btn-delete, .upload-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 6px 12px;
      min-width: 60px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .upload-btn {
      background-color: #16a34a;
    }
    .upload-btn:hover {
      background-color: #15803d;
    }
    button.btn-edit:hover, button.btn-delete:hover {
      color: #34d399;
    }
    .upload-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    input[type="checkbox"] {
      transform: scale(1.2);
      cursor: pointer;
    }
    .buttons-container {
      margin-bottom: 20px;
      display: flex;
      gap: 16px;
    }
    .btn-create {
      background-color: #34d399;
      color: white;
      border: none;
      padding: 14px 36px;
      border-radius: 36px;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-create:hover {
      background-color: #2fa87a;
    }
    /* NEW: Style for completed rows */
    .status-completed {
      background-color: #164e26 !important; /* dark green */
      color: #a7f3d0;
      font-weight: 700;
    }

    /* Modal Styles */
    #shareModal, #importModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #shareModal:target, #importModal:target {
      display: flex;
    }
    .modal-content {
      background-color: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      color: white;
    }
    .modal-content h3 {
      margin-top: 0;
      color: #03c988;
      text-align: center;
    }
    .modal-content label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
    }
    .modal-content input {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      background-color: #121212;
      border: 1px solid #555;
      border-radius: 6px;
      color: white;
      font-size: 14px;
    }
    .modal-content input[type="file"] {
      background-color: #2a2e35;
      border: 2px dashed #555;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
    }
    .modal-content input[type="file"]::-webkit-file-upload-button {
      background-color: #03c988;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      margin-right: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    .modal-content button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      background-color: #03c988;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      color: white;
      font-size: 16px;
    }
    .modal-content button.cancel-btn {
      background-color: #2a2e35;
      margin-top: 10px;
    }

    /* Filter container */
    #filterContainer {
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    #filterContainer label {
      font-weight: 600;
    }
    #filterContainer input[type="date"] {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #555;
      background-color: #121212;
      color: white;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }
    #filterContainer button {
      background-color: #03c988;
      border: none;
      color: white;
      padding: 10px 24px;
      border-radius: 36px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #filterContainer button:hover {
      background-color: #028f63;
    }
  </style>
</head>
<body>

<nav>
  <div class="nav-title">Training Horizon</div>
  <div class="nav-links">
    <a href="table.html">My Trainings</a>
    <a href="main.html">Calendar</a>
    <a href="records.html">Records</a>
    <div class="dropdown">
      <span class="dropdown-btn">User</span>
      <div class="dropdown-content">
        <a href="profile.html">Profile</a>
        <a href="#" id="logoutLink">Logout</a>
      </div>
    </div>
  </div>
</nav>

<div class="container">
  <h1>Training Sessions Table</h1>

  <!-- Filter -->
  <div id="filterContainer">
    <label for="filterStartDate">Start Date:</label>
    <input type="date" id="filterStartDate" />
    <label for="filterEndDate">End Date:</label>
    <input type="date" id="filterEndDate" />
    <button onclick="applyDateFilter()">Filter</button>
    <button onclick="clearDateFilter()" style="background:#555;">Clear</button>
  </div>

  <div class="buttons-container">
    <button class="btn-create" onclick="location.href='session.html'">Create Session</button>
    <button class="btn-create" onclick="openShareModal()" title="Share Table">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="20" height="20" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="18" cy="5" r="3"></circle>
        <circle cx="6" cy="12" r="3"></circle>
        <circle cx="18" cy="19" r="3"></circle>
        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
      </svg>
      Share
    </button>
    <button class="btn-create" onclick="openImportModal()" title="Import from CSV">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="20" height="20" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14,2 14,8 20,8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10,9 9,9 8,9"></polyline>
      </svg>
      Import
    </button>
  </div>
  <div class="summary" id="summaryDisplay">Total Hours: 0 | Actual Hours: 0 | Percentage: 0%</div>
  <table>
    <thead>
      <tr>
        <th>Complete</th>
        <th>Edit</th>
        <th>Delete</th>
        <th>Training Sheet</th>
        <th>Name</th>
        <th>Date &amp; Time</th>
        <th>Duration</th>
        <th>Venue</th>
        <th>Participants</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="trainingBody"></tbody>
  </table>
</div>

<!-- Share Modal -->
<div id="shareModal">
  <div class="modal-content">
    <h3>Share Training Data</h3>
    <label for="shareEmail">Email:</label>
    <input type="email" id="shareEmail" placeholder="Enter email" />
    <label for="shareStartDate">Start Date:</label>
    <input type="date" id="shareStartDate" />
    <label for="shareEndDate">End Date:</label>
    <input type="date" id="shareEndDate" />
    <button onclick="submitShare()">Share</button>
    <button class="cancel-btn" onclick="closeShareModal()">Cancel</button>
  </div>
</div>

<!-- Import Modal -->
<div id="importModal">
  <div class="modal-content">
    <h3>Import Training Data</h3>
    <p style="font-size: 14px; color: #888; margin-bottom: 20px;">
      Select a CSV file with the same format as exported data. All imported trainings will be marked as pending.
    </p>
    <label for="csvFile">CSV File:</label>
    <input type="file" id="csvFile" accept=".csv" style="margin-top: 6px;" />
    <button onclick="submitImport()">Import</button>
    <button class="cancel-btn" onclick="closeImportModal()">Cancel</button>
  </div>
</div>

<script>
  // Redirect if authToken missing
  if (!localStorage.getItem('authToken')) {
    window.location.href = 'homepage.html';
  }

  // Logout functionality
  document.getElementById('logoutLink').addEventListener('click', function(e) {
    e.preventDefault();
    localStorage.removeItem('authToken');
    window.location.href = 'homepage.html';
  });

  // Close modals when clicking outside
  document.getElementById('shareModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeShareModal();
    }
  });

  document.getElementById('importModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeImportModal();
    }
  });

  let allTrainings = [];

  function formatDateTime(dateStr) {
    if (!dateStr) return '';
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    let date = new Date(dateStr);
    if (isNaN(date.getTime())) {
      date = new Date(dateStr + 'T00:00:00Z');
    }
    if (isNaN(date.getTime())) return '';
    
    const day = String(date.getDate()).padStart(2, '0');
    const month = months[date.getMonth()];
    const year = date.getFullYear();
    
    let hours = date.getHours();
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    const formattedHours = String(hours).padStart(2, '0');
    
    return `${day}/${month}/${year} ${formattedHours}:${minutes}${ampm}`;
  }

  // Fetch and display trainings
  async function fetchTrainings() {
    const res = await fetch('/api/trainings/my-trainings', {
      headers: { 'x-auth-token': localStorage.getItem('authToken') }
    });
    const data = await res.json();
    allTrainings = data;
    displayTrainings(allTrainings);
  }

  function displayTrainings(trainings) {
    const tbody = document.getElementById('trainingBody');
    tbody.innerHTML = '';

    // Sort trainings by schedule_date descending
    trainings.sort((a,b) => new Date(b.schedule_date) - new Date(a.schedule_date));

    trainings.forEach(training => {
      const row = document.createElement('tr');
      // Add class if status is 'completed'
      const rowClass = training.status === 'completed' ? 'status-completed' : '';
      row.className = rowClass;

      row.innerHTML = `
        <td class="checkbox-cell"><input type="checkbox" class="session-check" onchange="toggleStatus(${training.id}, this.checked)" ${training.status === 'completed' ? 'checked' : ''}></td>
        <td class="edit-cell">
          <button class="btn-edit" onclick="location.href='edit.html?id=${training.id}'" title="Edit">✏️</button>
        </td>
        <td class="delete-cell"><button class="btn-delete" onclick="deleteTraining(${training.id})" title="Delete">🗑️</button></td>
        <td class="upload-cell">
          <button class="upload-btn" id="uploadBtn-${training.id}" onclick="handleFileAction(${training.id})" title="Upload File">Upload</button>
        </td>
        <td>${training.name}</td>
        <td>${formatDateTime(training.schedule_date)}</td>
        <td class="duration">${training.duration}</td>
        <td>${training.venue}</td>
        <td class="participants">${training.number_of_participants}</td>
        <td>${training.status}</td>
      `;
      tbody.appendChild(row);
    });
    updateSummary();
    checkFilesForTrainings(trainings);
  }

  // Check if files exist for trainings and update buttons accordingly
  async function checkFilesForTrainings(trainings) {
    for (const training of trainings) {
      try {
        const response = await fetch(`/api/files/training/${training.id}`, {
          headers: { 'x-auth-token': localStorage.getItem('authToken') }
        });
        const result = await response.json();
        const button = document.getElementById(`uploadBtn-${training.id}`);
        
        if (response.ok && result.files && result.files.length > 0) {
          // Files exist, show View button
          button.textContent = 'View';
          button.title = 'View Files';
          button.style.backgroundColor = '#2563eb';
        } else {
          // No files, show Upload button
          button.textContent = 'Upload';
          button.title = 'Upload File';
          button.style.backgroundColor = '';
        }
      } catch (error) {
        console.error('Error checking files for training:', training.id, error);
      }
    }
  }

  function deleteTraining(id) {
    if (confirm('Are you sure you want to delete this training? This action cannot be undone.')) {
      fetch(`/api/trainings/${id}`, {
        method: 'DELETE',
        headers: { 'x-auth-token': localStorage.getItem('authToken') }
      })
      .then(res => res.json())
      .then(() => fetchTrainings());
    }
  }

  async function toggleStatus(id, complete) {
    // If trying to mark as complete, check if files have been uploaded
    if (complete) {
      try {
        const response = await fetch(`/api/files/training/${id}`, {
          headers: { 'x-auth-token': localStorage.getItem('authToken') }
        });
        const result = await response.json();
        
        // Check if no files exist for this training
        if (!response.ok || !result.files || result.files.length === 0) {
          // Show alert and uncheck the checkbox
          alert('Please upload a training sheet before marking this training as complete.');
          
          // Find the checkbox and uncheck it
          const checkbox = document.querySelector(`input[onchange*="toggleStatus(${id}"]`);
          if (checkbox) {
            checkbox.checked = false;
          }
          return;
        }
      } catch (error) {
        console.error('Error checking files for training:', id, error);
        alert('Error checking files. Please try again.');
        
        // Find the checkbox and uncheck it
        const checkbox = document.querySelector(`input[onchange*="toggleStatus(${id}"]`);
        if (checkbox) {
          checkbox.checked = false;
        }
        return;
      }
    }

    // Proceed with status update
    fetch('/api/trainings/status', {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'x-auth-token': localStorage.getItem('authToken')
      },
      body: JSON.stringify({ training_id: id, status: complete ? 'completed' : 'pending' })
    }).then(() => fetchTrainings());
  }

  function updateSummary() {
    const rows = document.querySelectorAll("tbody tr");
    let total = 0, actual = 0;
    rows.forEach(row => {
      const participants = parseFloat(row.querySelector(".participants")?.textContent) || 0;
      const duration = parseFloat(row.querySelector(".duration")?.textContent) || 0;
      const isChecked = row.querySelector(".session-check")?.checked;
      total += participants * duration;
      if (isChecked) actual += participants * duration;
    });
    const percent = total ? ((actual / total) * 100).toFixed(1) : 0;
    document.getElementById("summaryDisplay").textContent =
      `Total Hours: ${total.toFixed(1)} | Actual Hours: ${actual.toFixed(1)} | Percentage: ${percent}%`;
  }

  function openShareModal() {
    document.getElementById('shareModal').style.display = 'flex';
  }

  function closeShareModal() {
    document.getElementById('shareModal').style.display = 'none';
  }

  function openImportModal() {
    document.getElementById('importModal').style.display = 'flex';
  }

  function closeImportModal() {
    document.getElementById('importModal').style.display = 'none';
    document.getElementById('csvFile').value = ''; // Clear file input
  }

  function submitImport() {
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];

    if (!file) {
      alert('Please select a CSV file.');
      return;
    }

    if (!file.name.toLowerCase().endsWith('.csv')) {
      alert('Please select a valid CSV file.');
      return;
    }

    const formData = new FormData();
    formData.append('csvFile', file);

    // Show loading state
    const importButton = document.querySelector('#importModal button[onclick="submitImport()"]');
    const originalText = importButton.textContent;
    importButton.textContent = 'Importing...';
    importButton.disabled = true;

    fetch('/api/trainings/import', {
      method: 'POST',
      headers: {
        'x-auth-token': localStorage.getItem('authToken')
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.msg) {
        alert(data.msg);
        closeImportModal();
        fetchTrainings(); // Refresh the table
      } else {
        alert(data.errors?.[0]?.msg || 'Import failed.');
      }
    })
    .catch(() => {
      alert('Failed to import data.');
    })
    .finally(() => {
      // Reset button state
      importButton.textContent = originalText;
      importButton.disabled = false;
    });
  }

 let shareBtnBlocked = false;

function submitShare() {
  if (shareBtnBlocked) {
    alert("Click after 5 seconds");
    // Change calendar icon color to white for inputs in modal
    document.querySelectorAll('#shareModal input[type="date"]').forEach(input => {
      input.style.color = "white";
      input.style.backgroundColor = "#121212"; // keep background consistent
      input.style.borderColor = "#fff"; // make border white to highlight
    });
    return;
  }

  shareBtnBlocked = true;

  // Reset blocking and calendar icon styles after 5 seconds
  setTimeout(() => {
    shareBtnBlocked = false;
    document.querySelectorAll('#shareModal input[type="date"]').forEach(input => {
      input.style.color = "";
      input.style.borderColor = "";
    });
  }, 5000);

  const email = document.getElementById('shareEmail').value.trim();
  const startDate = document.getElementById('shareStartDate').value;
  const endDate = document.getElementById('shareEndDate').value;

  if (!email) {
    alert('Please enter an email.');
    shareBtnBlocked = false; // unblock if validation fails
    return;
  }
  if (!startDate) {
    alert('Please select a start date.');
    shareBtnBlocked = false;
    return;
  }
  if (!endDate) {
    alert('Please select an end date.');
    shareBtnBlocked = false;
    return;
  }
  if (startDate > endDate) {
    alert('Start date cannot be after end date.');
    shareBtnBlocked = false;
    return;
  }

  function formatDateForApi(isoDateStr) {
    if (!isoDateStr) return '';
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const d = new Date(isoDateStr);
    if (isNaN(d)) return '';
    const day = String(d.getDate()).padStart(2, '0');
    const month = months[d.getMonth()];
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
  }

  fetch('/api/trainings/shareTrainingData', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-auth-token': localStorage.getItem('authToken')
    },
    body: JSON.stringify({ 
      email, 
      startDate: formatDateForApi(startDate), 
      endDate: formatDateForApi(endDate) 
    })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.msg || data.errors?.[0]?.msg || 'Shared successfully.');
    closeShareModal();
  })
  .catch(() => {
    alert('Failed to share data.');
  });
}


  // Filter function to show only trainings within selected date range
  function applyDateFilter() {
    const startDateStr = document.getElementById('filterStartDate').value;
    const endDateStr = document.getElementById('filterEndDate').value;

    if (startDateStr && endDateStr && startDateStr > endDateStr) {
      alert('Start date cannot be after end date.');
      return;
    }

    let filtered = allTrainings;

    if (startDateStr) {
      const startDate = new Date(startDateStr);
      filtered = filtered.filter(t => new Date(t.schedule_date) >= startDate);
    }
    if (endDateStr) {
      const endDate = new Date(endDateStr);
      filtered = filtered.filter(t => new Date(t.schedule_date) <= endDate);
    }

    displayTrainings(filtered);
  }

  function clearDateFilter() {
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    displayTrainings(allTrainings);
  }

  // Handle both upload and view file actions
  function handleFileAction(trainingId) {
    const button = document.getElementById(`uploadBtn-${trainingId}`);
    if (button.textContent === 'Upload') {
      uploadFile(trainingId);
    } else {
      viewFiles(trainingId);
    }
  }

  // View files for a training
  async function viewFiles(trainingId) {
    // Redirect to the dedicated view files page
    window.location.href = `view-files.html?id=${trainingId}`;
  }

  // Upload button handler
  function uploadFile(trainingId) {
    // Create a file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*,application/pdf,.pdf';
    fileInput.style.display = 'none';
    
    // Handle file selection
    fileInput.onchange = function(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Validate file type
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
      if (!allowedTypes.includes(file.type)) {
        alert('Please select an image file (JPEG, PNG, GIF, WebP) or PDF file.');
        return;
      }
      
      // Validate file size (10MB limit)
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        alert('File size must be less than 10MB.');
        return;
      }
      
      // Upload the file
      uploadFileToServer(trainingId, file);
    };
    
    // Trigger file selection dialog
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
  }
  
  // Function to upload file to server
  async function uploadFileToServer(trainingId, file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('training_id', trainingId);
    
    try {
      // Show loading state
      const uploadButtons = document.querySelectorAll(`#uploadBtn-${trainingId}`);
      uploadButtons.forEach(btn => {
        btn.textContent = '⏳';
        btn.disabled = true;
      });
      
      const response = await fetch('/api/files/upload', {
        method: 'POST',
        headers: {
          'x-auth-token': localStorage.getItem('authToken')
        },
        body: formData
      });
      
      const result = await response.json();
      
      if (response.ok) {
        alert('File uploaded successfully!');
        // Update button to "View" after successful upload
        const button = document.getElementById(`uploadBtn-${trainingId}`);
        if (button) {
          button.textContent = 'View';
          button.title = 'View Files';
          button.style.backgroundColor = '#2563eb';
        }
        // Refresh the page to show updated training status
        location.reload();
      } else {
        alert('Upload failed: ' + (result.msg || 'Unknown error'));
      }
    } catch (error) {
      console.error('Upload error:', error);
      alert('Upload failed: Network error');
    } finally {
      // Reset button state (only if upload failed)
      const button = document.getElementById(`uploadBtn-${trainingId}`);
      if (button && button.disabled) {
        button.disabled = false;
        // Only reset to original state if it's not already "View"
        if (button.textContent === '⏳') {
          button.textContent = 'Upload';
        }
      }
    }
  }

  fetchTrainings();
</script>
</body>
</html>
